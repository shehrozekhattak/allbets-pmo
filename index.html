<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite PMO Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .nav-item.active { background-color: #334155; color: white; border-left: 4px solid #3b82f6; }
        .nav-item { border-left: 4px solid transparent; }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-slate-800">

    <aside class="w-64 bg-slate-900 text-slate-300 flex flex-col shadow-2xl z-10">
        <div class="h-16 flex items-center px-6 border-b border-slate-800">
            <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center text-white font-bold mr-3">E</div>
            <span class="font-bold text-white tracking-wide">allBETs</span>
        </div>

        <nav class="flex-1 py-6 space-y-1">
            <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-item active w-full flex items-center px-6 py-3 hover:bg-slate-800 transition">
                <i class="fa-solid fa-chart-pie w-6"></i>
                <span class="font-medium">Dashboard</span>
            </button>
            <button onclick="switchTab('list')" id="nav-list" class="nav-item w-full flex items-center px-6 py-3 hover:bg-slate-800 transition">
                <i class="fa-solid fa-table-list w-6"></i>
                <span class="font-medium">Master Task List</span>
            </button>
        </nav>

        <div class="p-4 border-t border-slate-800">
            <button onclick="resetData()" class="text-xs text-red-400 hover:text-red-300 flex items-center">
                <i class="fa-solid fa-trash mr-2"></i> Reset All Data
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden bg-slate-50">

        <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 shadow-sm z-10">
            <div>
                <h2 class="text-xl font-bold text-slate-800" id="page-title">Dashboard</h2>
                <p class="text-xs text-slate-500">Project: Core Feature & Personalization</p>
            </div>
            <div class="flex items-center space-x-6">
                <div class="text-right">
                    <div class="text-xs font-bold text-slate-500 uppercase">Velocity</div>
                    <div class="text-sm font-bold text-blue-600" id="header-velocity">0%</div>
                </div>
                <button onclick="openModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-bold shadow-lg transition">
                    <i class="fa-solid fa-plus mr-2"></i> New Task
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8" id="content-area">

            <div id="view-dashboard" class="space-y-6">

                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                        <p class="text-xs font-bold text-slate-400 uppercase">Total Tasks</p>
                        <p class="text-3xl font-bold text-slate-800 mt-2" id="kpi-total">0</p>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-red-500">
                        <p class="text-xs font-bold text-red-500 uppercase">Critical Open</p>
                        <p class="text-3xl font-bold text-slate-800 mt-2" id="kpi-critical">0</p>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-orange-500">
                        <p class="text-xs font-bold text-orange-500 uppercase">Active Blockers</p>
                        <p class="text-3xl font-bold text-slate-800 mt-2" id="kpi-blocked">0</p>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-blue-500">
                        <p class="text-xs font-bold text-blue-500 uppercase">Next Deadline</p>
                        <p class="text-3xl font-bold text-slate-800 mt-2" id="kpi-days">--</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="px-6 py-4 border-b border-slate-100 bg-red-50 flex justify-between items-center">
                            <h3 class="font-bold text-red-700 text-sm uppercase"><i class="fa-solid fa-hand mr-2"></i> Active Blockers</h3>
                        </div>
                        <table class="w-full text-sm text-left">
                            <tbody id="dashboard-blocker-list"></tbody>
                        </table>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="px-6 py-4 border-b border-slate-100 bg-orange-50 flex justify-between items-center">
                            <h3 class="font-bold text-orange-700 text-sm uppercase"><i class="fa-solid fa-circle-question mr-2"></i> Missing Info</h3>
                        </div>
                        <table class="w-full text-sm text-left">
                            <tbody id="dashboard-missing-list"></tbody>
                        </table>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="text-xs font-bold text-slate-400 uppercase mb-4">Status Breakdown</h3>
                        <canvas id="statusChart"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 col-span-2">
                        <h3 class="text-xs font-bold text-slate-400 uppercase mb-4">Owner Health Breakdown</h3>
                        <canvas id="workloadChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="view-list" class="hidden">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-600">
                            <thead class="bg-slate-50 text-xs uppercase font-bold text-slate-500">
                                <tr>
                                    <th class="px-4 py-3">Health</th>
                                    <th class="px-4 py-3">ID</th>
                                    <th class="px-4 py-3 w-1/4">Task</th>
                                    <th class="px-4 py-3">Owner</th>
                                    <th class="px-4 py-3">Priority</th>
                                    <th class="px-4 py-3">Due Date</th>
                                    <th class="px-4 py-3">Status</th>
                                    <th class="px-4 py-3">Updates</th>
                                </tr>
                            </thead>
                            <tbody id="master-list-body" class="divide-y divide-slate-100">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <div id="taskModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
            <h2 class="text-lg font-bold mb-4">Add New Task</h2>
            <form id="taskForm" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase">Task ID</label>
                    <input type="text" id="input-id" class="w-full border border-slate-300 rounded p-2 mt-1" placeholder="e.g. M1.4">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase">Task Name</label>
                    <input type="text" id="input-name" class="w-full border border-slate-300 rounded p-2 mt-1" placeholder="Task description">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase">Owner</label>
                        <select id="input-owner" class="w-full border border-slate-300 rounded p-2 mt-1">
                            <option>Michael</option><option>Primitivo</option><option>Natish</option><option>Ty</option><option>Shahroze</option><option>Nitesh</option><option>Unassigned</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase">Priority</label>
                        <select id="input-priority" class="w-full border border-slate-300 rounded p-2 mt-1">
                            <option>P1: Critical</option><option>P2: High</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase">Due Date</label>
                        <input type="date" id="input-due" class="w-full border border-slate-300 rounded p-2 mt-1">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase">Status</label>
                        <select id="input-status" class="w-full border border-slate-300 rounded p-2 mt-1">
                            <option>Not Started</option><option>In Progress</option><option>Blocked</option><option>Done</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase">Blocker / Missing Info</label>
                    <input type="text" id="input-blocker" class="w-full border border-slate-300 rounded p-2 mt-1" placeholder="Optional details">
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700">Save Task</button>
                </div>
            </form>
        </div>
    </div>

    <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzngQwNMxbVSm4Ih_wlhy_O1-f3C5DQ_G3dpqtY-VSZHPXcEGDUcdm-Kls9z2dF481ldQ/exec";
    let tasks = [];
    let statusChartInstance = null;
    let workloadChartInstance = null;

    // Load data from Google Sheets
    async function loadData() {
        console.log("Fetching data from Sheets...");
        document.getElementById('master-list-body').innerHTML = '<tr><td colspan="8" class="text-center py-4 text-slate-500"><i class="fa-solid fa-circle-notch fa-spin mr-2"></i>Syncing with Google Sheets...</td></tr>';

        try {
            const response = await fetch(API_URL);
            const data = await response.json();
            console.log("Data received:", data);
            if (!Array.isArray(data)) throw new Error('Invalid data format from API');
            tasks = data;
            renderAll();
        } catch (error) {
            console.error("Fetch error:", error);
            alert("Error loading data. Check your console (F12) for details. Falling back to sample data.");
            // Fallback to sample data
            tasks = [
                { healthScore: 'â›” BLOCKED', id: 'M1.1', name: 'Implement Post â†’ Many Bets logic.', description: '', workstream: 'Core Feature', owner: 'Primitivo', priority: 'P1:Critical', due: '2025-12-05', status: 'Blocked', daysUntilDue: 16, dependencies: 'N/A', dependencyHealth: 'ðŸŸ¢ Open', risksBlockers: 'Developer capacity.', missingInfo: 'TBD: Specific screens/components.', updates: '' },
                { healthScore: 'âšª TO DO', id: 'M1.2', name: 'Implement \'Swipe Past Last Media\' â†’ Tinder Feed UX.', description: '', workstream: 'Core Feature', owner: 'Primitivo', priority: 'P1:Critical', due: '2025-12-05', status: 'Not Started', daysUntilDue: 16, dependencies: 'N/A', dependencyHealth: 'ðŸŸ¢ Open', risksBlockers: 'UX for single-media posts (fake "n+1" element) needs clear implementation spec.', missingInfo: 'TBD: Exact implementation of fake element.', updates: '' },
                { healthScore: 'âšª TO DO', id: 'M1.3', name: 'Keep \'Bet Button\' on Post UI (links to Bets Feed).', description: '', workstream: 'Core Feature', owner: 'Primitivo', priority: 'P2:High', due: '2025-12-05', status: 'Not Started', daysUntilDue: 16, dependencies: 'N/A', dependencyHealth: 'ðŸŸ¢ Open', risksBlockers: 'Potential UI clutter.', missingInfo: '', updates: '' },
                { healthScore: 'â›” WAITING', id: 'M2.1', name: 'Update backend DTO to accept hashtags.', description: '', workstream: 'Core Feature', owner: 'Michael', priority: 'P1:Critical', due: '2025-12-02', status: 'Not Started', daysUntilDue: 13, dependencies: 'N/A', dependencyHealth: 'â›” BLOCKED', risksBlockers: 'Required changes in Kuboto/Gaboto.', missingInfo: '', updates: '' },
                { healthScore: 'â›” WAITING', id: 'M2.2', name: 'Integrate Post Media Upload endpoint.', description: '', workstream: 'Core Feature', owner: 'Michael', priority: 'P1:Critical', due: '2025-12-05', status: 'Not Started', daysUntilDue: 16, dependencies: 'M2.1', dependencyHealth: 'â›” BLOCKED', risksBlockers: 'Need clear spec on expected media format/storage location.', missingInfo: 'TBD: Backend upload endpoint URL/specs.', updates: '' },
                { healthScore: 'â›” WAITING', id: 'M3.1', name: 'Update React Native app (look & feel from web app).', description: '', workstream: 'Core Feature', owner: 'Unassigned', priority: 'P1:Critical', due: '2025-12-08', status: 'Not Started', daysUntilDue: 19, dependencies: 'M1.1, M1.2, M1.3', dependencyHealth: 'â›” BLOCKED', risksBlockers: 'Potential technical debt/breaking changes from old build.', missingInfo: 'TBD: Anish status, Team assigned.', updates: '' },
                { healthScore: 'âšª TO DO', id: 'M3.2', name: 'Prepare and release mobile app to Google Play/App Store.', description: '', workstream: 'Core Feature', owner: 'Unassigned', priority: 'P1:Critical', due: '2025-12-15', status: 'Not Started', daysUntilDue: 26, dependencies: 'M3.1', dependencyHealth: 'ðŸŸ¢ Open', risksBlockers: 'Expired Google Play/App Store credentials.', missingInfo: 'TBD: Verification of Google/Apple dev account access.', updates: '' },
                { healthScore: 'â›” WAITING', id: 'M4.1', name: 'Create Figma files for comment section UI.', description: '', workstream: 'Support', owner: 'Primitivo', priority: 'P2:High', due: '2025-12-12', status: 'Not Started', daysUntilDue: 23, dependencies: 'N/A', dependencyHealth: 'â›” BLOCKED', risksBlockers: '', missingInfo: '', updates: '' },
                { healthScore: 'âšª TO DO', id: 'M5.2', name: 'Grant Trello access to new devs.', description: '', workstream: 'Onboarding/Setup', owner: 'Michael', priority: 'P1:Critical', due: '2025-11-20', status: 'Not Started', daysUntilDue: 1, dependencies: 'M5.3', dependencyHealth: 'ðŸŸ¢ Open', risksBlockers: 'Cannot add new devs until duplicates are resolved.', missingInfo: '', updates: '' },
                { healthScore: 'âšª TO DO', id: 'M5.3', name: 'Ask Natish which Trello account to keep, reassign tasks, and delete duplicate.', description: '', workstream: 'Onboarding/Setup', owner: 'Michael', priority: 'P1:Critical', due: '2025-11-20', status: 'Not Started', daysUntilDue: 1, dependencies: 'N/A', dependencyHealth: 'ðŸŸ¢ Open', risksBlockers: '', missingInfo: '', updates: '' },
                { healthScore: 'âšª TO DO', id: 'M6.1', name: 'Ask Cursor AI to create Windows equivalents for local setup scripts.', description: '', workstream: 'Support', owner: 'Michael', priority: 'P2:High', due: '2025-11-25', status: 'Not Started', daysUntilDue: 6, dependencies: 'N/A', dependencyHealth: 'ðŸŸ¢ Open', risksBlockers: 'Windows users blocked from setup.', missingInfo: '', updates: '' },
                { healthScore: 'âšª TO DO', id: 'M7.2', name: 'Build logic for settlement disputes and "all bets jail" restrictions.', description: '', workstream: 'Core Feature', owner: 'Unassigned', priority: 'P2:High', due: '2025-12-20', status: 'Not Started', daysUntilDue: 31, dependencies: 'N/A', dependencyHealth: 'ðŸŸ¢ Open', risksBlockers: '', missingInfo: '', updates: '' },
                { healthScore: 'â›” WAITING', id: 'P1.1', name: 'Conduct feasibility check for all three personalization features.', description: '', workstream: 'Personalization', owner: 'Ty', priority: 'P2:High', due: '2025-11-28', status: 'Not Started', daysUntilDue: 9, dependencies: 'N/A', dependencyHealth: 'â›” BLOCKED', risksBlockers: 'Ty\'s limited graph DB experience.', missingInfo: 'TBD: Final list of 3 features to assess.', updates: '' },
                { healthScore: 'â›” WAITING', id: 'P1.2', name: 'Map each feature against Gaboto/Kuboto API capacity (needed vs existing).', description: '', workstream: 'Personalization', owner: 'Shahroze', priority: 'P1:Critical', due: '2025-12-02', status: 'Not Started', daysUntilDue: 13, dependencies: 'P1.1', dependencyHealth: 'â›” BLOCKED', risksBlockers: 'Access to Gaboto GitHub repo for Ty/team.', missingInfo: '', updates: '' },
                { healthScore: 'â›” WAITING', id: 'P1.3', name: 'Document the three deliverables (feasibility, API required, phase plan).', description: '', workstream: 'Personalization', owner: 'Nitesh', priority: 'P1:Critical', due: '2025-12-05', status: 'Not Started', daysUntilDue: 16, dependencies: 'P1.1, P1.2', dependencyHealth: 'â›” BLOCKED', risksBlockers: '', missingInfo: '', updates: '' },
                { healthScore: 'âšª TO DO', id: 'P2.1', name: 'Implement features that do not require backend updates (Web App first).', description: '', workstream: 'Personalization', owner: 'Nitesh', priority: 'P1:Critical', due: '2025-12-01', status: 'Not Started', daysUntilDue: 12, dependencies: 'P3.1', dependencyHealth: 'ðŸŸ¢ Open', risksBlockers: 'Lack of clear algorithm specs before coding.', missingInfo: '', updates: '' },
                { healthScore: 'âšª TO DO', id: 'P3.1', name: 'Implement view-duration tracking on Web App (>3s/5s).', description: '', workstream: 'Personalization', owner: 'Ty', priority: 'P1:Critical', due: '2025-11-29', status: 'Not Started', daysUntilDue: 10, dependencies: 'N/A', dependencyHealth: 'ðŸŸ¢ Open', risksBlockers: 'Need to define backend logging endpoint for view time.', missingInfo: '', updates: '' },
                { healthScore: 'âšª TO DO', id: 'P3.3', name: 'Use ChatGPT to draft Neo4J query specs for algorithms.', description: '', workstream: 'Personalization', owner: 'Nitesh', priority: 'P1:Critical', due: '2025-11-27', status: 'Not Started', daysUntilDue: 8, dependencies: 'N/A', dependencyHealth: 'ðŸŸ¢ Open', risksBlockers: '', missingInfo: '', updates: '' }
            ];
            renderAll();
        }
    }

    // Update status to Google Sheets
    async function updateStatus(index, newStatus) {
        const task = tasks[index];

        // Optimistic update
        const oldStatus = task.status;
        task.status = newStatus;
        renderAll();

        // Send to Google
        try {
            await fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'update', id: task.id, status: newStatus })
            });
            console.log(`Task ${task.id} updated to ${newStatus}`);
        } catch (error) {
            console.error("Update error:", error);
            alert("Failed to save to Google Sheet. Reverting.");
            task.status = oldStatus;
            renderAll();
        }
    }

    // Health calculation based on healthScore
    function calculateHealth(task) {
        const score = task.healthScore;
        if (score.includes('BLOCKED')) return { label: 'BLOCKED', color: 'bg-red-100 text-red-700' };
        if (score.includes('WAITING')) return { label: 'WAITING', color: 'bg-orange-100 text-orange-700' };
        if (score.includes('TO DO')) return { label: 'TO DO', color: 'bg-gray-100 text-gray-500' };
        return { label: 'ON TRACK', color: 'bg-blue-50 text-blue-600' };
    }

    function renderAll() {
        renderStats();
        renderLists();
        renderCharts();
    }

    function renderStats() {
        const total = tasks.length;
        const critical = tasks.filter(t => t.priority && t.priority.includes('P1') && t.status !== 'Done').length;
        const blocked = tasks.filter(t => t.status === 'Blocked').length;
        const done = tasks.filter(t => t.status === 'Done').length;

        const upcoming = tasks
            .filter(t => t.status !== 'Done' && t.due)
            .map(t => new Date(t.due))
            .sort((a,b) => a-b);

        let daysLeft = '--';
        if(upcoming.length > 0) {
            const diff = Math.ceil((upcoming[0] - new Date()) / (1000 * 60 * 60 * 24));
            daysLeft = diff + ' Days';
        }

        document.getElementById('kpi-total').innerText = total;
        document.getElementById('kpi-critical').innerText = critical;
        document.getElementById('kpi-blocked').innerText = blocked;
        document.getElementById('kpi-days').innerText = daysLeft;

        const velocity = total === 0 ? 0 : Math.round((done/total)*100);
        document.getElementById('header-velocity').innerText = velocity + '%';
    }

    function renderLists() {
        const dashBlocker = document.getElementById('dashboard-blocker-list');
        dashBlocker.innerHTML = '';
        tasks.filter(t => t.status === 'Blocked').forEach(t => {
            dashBlocker.innerHTML += `<tr class="border-b border-slate-50 last:border-0"><td class="px-6 py-3 font-medium text-slate-700">${t.name} <span class="block text-xs text-red-500">${t.risksBlockers || 'No detail'}</span></td><td class="px-6 py-3 text-right text-xs text-slate-400">${t.owner}</td></tr>`;
        });

        const dashMissing = document.getElementById('dashboard-missing-list');
        dashMissing.innerHTML = '';
        tasks.filter(t => t.owner === 'Unassigned' || (t.status !== 'Done' && t.missingInfo)).forEach(t => {
            dashMissing.innerHTML += `<tr class="border-b border-slate-50 last:border-0"><td class="px-6 py-3 font-medium text-slate-700">${t.name} <span class="block text-xs text-orange-500">${t.missingInfo || 'Unassigned / Scoping'}</span></td><td class="px-6 py-3 text-right text-xs text-slate-400">${t.id}</td></tr>`;
        });

        const masterBody = document.getElementById('master-list-body');
        masterBody.innerHTML = '';
        tasks.forEach((t, index) => {
            const health = calculateHealth(t);
            let dateDisplay = '';
            if(t.due) {
                try { dateDisplay = new Date(t.due).toISOString().split('T')[0]; } catch(e) { dateDisplay = t.due; }
            }

            masterBody.innerHTML += `
                <tr class="hover:bg-slate-50 transition group">
                    <td class="px-4 py-3"><span class="px-2 py-1 rounded text-xs font-bold ${health.color}">${health.label}</span></td>
                    <td class="px-4 py-3 font-mono text-xs font-bold text-slate-400">${t.id}</td>
                    <td class="px-4 py-3 font-medium text-slate-700" title="${t.description || ''}">${t.name}</td>
                    <td class="px-4 py-3 text-xs">${t.owner}</td>
                    <td class="px-4 py-3 text-xs font-bold ${t.priority && t.priority.includes('P1') ? 'text-red-600' : 'text-slate-500'}">${t.priority}</td>
                    <td class="px-4 py-3 text-xs text-slate-500">${dateDisplay}</td>
                    <td class="px-4 py-3">
                        <select onchange="updateStatus(${index}, this.value)" class="bg-transparent text-xs border-b border-transparent hover:border-slate-300 focus:border-blue-500 outline-none cursor-pointer font-medium text-slate-700">
                            <option ${t.status==='Not Started'?'selected':''}>Not Started</option>
                            <option ${t.status==='In Progress'?'selected':''}>In Progress</option>
                            <option ${t.status==='Blocked'?'selected':''}>Blocked</option>
                            <option ${t.status==='Done'?'selected':''}>Done</option>
                        </select>
                    </td>
                    <td class="px-4 py-3 text-xs text-slate-500">${t.updates || ''}</td>
                </tr>
            `;
        });
    }

    function renderCharts() {
        const statusCounts = [0,0,0,0];
        tasks.forEach(t => {
            if(t.status === 'Done') statusCounts[0]++;
            else if(t.status === 'Blocked') statusCounts[1]++;
            else if(t.status === 'In Progress') statusCounts[2]++;
            else statusCounts[3]++;
        });

        // Owner Health Stacked
        const ownerHealth = {};
        tasks.forEach(t => {
            if (!t.owner || t.owner === 'Unassigned') return;
            const owners = t.owner.split(',').map(o => o.trim()).filter(o => o);
            let health = 'ON TRACK';
            if (t.healthScore.includes('BLOCKED')) health = 'BLOCKED';
            else if (t.healthScore.includes('WAITING')) health = 'WAITING';
            else if (t.healthScore.includes('TO DO')) health = 'TO DO';
            owners.forEach(owner => {
                if (!ownerHealth[owner]) ownerHealth[owner] = { 'BLOCKED': 0, 'WAITING': 0, 'TO DO': 0, 'ON TRACK': 0 };
                ownerHealth[owner][health]++;
            });
        });

        const owners = Object.keys(ownerHealth);

        const ctx1 = document.getElementById('statusChart');
        if(statusChartInstance) statusChartInstance.destroy();
        statusChartInstance = new Chart(ctx1, {
            type: 'doughnut',
            data: {
                labels: ['Done', 'Blocked', 'In Progress', 'Not Started'],
                datasets: [{ data: statusCounts, backgroundColor: ['#22c55e', '#ef4444', '#3b82f6', '#e2e8f0'], borderWidth:0 }]
            },
            options: { cutout: '70%', plugins: { legend: { position: 'right', labels: { boxWidth: 10 } } } }
        });

        const ctx2 = document.getElementById('workloadChart');
        if(workloadChartInstance) workloadChartInstance.destroy();
        workloadChartInstance = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: owners,
                datasets: [
                    { label: 'BLOCKED', data: owners.map(o => ownerHealth[o]['BLOCKED']), backgroundColor: '#ef4444' },
                    { label: 'WAITING', data: owners.map(o => ownerHealth[o]['WAITING']), backgroundColor: '#f59e0b' },
                    { label: 'TO DO', data: owners.map(o => ownerHealth[o]['TO DO']), backgroundColor: '#e2e8f0' },
                    { label: 'ON TRACK', data: owners.map(o => ownerHealth[o]['ON TRACK']), backgroundColor: '#10b981' }
                ]
            },
            options: {
                indexAxis: 'y',
                scales: {
                    x: { stacked: true, display: false },
                    y: { stacked: true, grid: { display: false } }
                },
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }

    function switchTab(tab) {
        document.getElementById('view-dashboard').classList.add('hidden');
        document.getElementById('view-list').classList.add('hidden');
        document.getElementById('nav-dashboard').classList.remove('active');
        document.getElementById('nav-list').classList.remove('active');

        document.getElementById('view-' + tab).classList.remove('hidden');
        document.getElementById('nav-' + tab).classList.add('active');
        document.getElementById('page-title').innerText = tab === 'dashboard' ? 'Dashboard' : 'Master Task List';
    }

    function openModal() {
        alert("Please add new tasks directly in the Google Sheet to ensure everyone sees them.");
    }

    function closeModal() {
        document.getElementById('taskModal').classList.add('hidden');
    }

    document.getElementById('taskForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const newTask = {
            healthScore: 'âšª TO DO',
            id: document.getElementById('input-id').value,
            name: document.getElementById('input-name').value,
            description: '',
            workstream: 'Core Feature',
            owner: document.getElementById('input-owner').value,
            priority: document.getElementById('input-priority').value,
            due: document.getElementById('input-due').value,
            status: document.getElementById('input-status').value,
            daysUntilDue: 0,
            dependencies: '',
            dependencyHealth: 'ðŸŸ¢ Open',
            risksBlockers: document.getElementById('input-blocker').value,
            missingInfo: '',
            updates: ''
        };
        tasks.push(newTask);
        renderAll();
        closeModal();
        e.target.reset();
    });

    function resetData() {
        if(confirm('Reset all data? This will reload sample data.')) {
            loadData();
        }
    }

    loadData();
    </script>
</body>
</html>
